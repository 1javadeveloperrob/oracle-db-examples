SQL> 
SQL> @make_fact
SQL> REM
SQL> REM Fact table for demo statistics query answering 
SQL> REM
SQL> set timing on
SQL> set linesize 250
SQL> set tab off
SQL> set trims on
SQL> set echo on
SQL>
SQL> drop table fact1 purge;

Error starting at line : 10 File @ /u01/npb/Features/GIT2/oracle-db-examples/optimizer/autonomous/stats_answering/make_fact.sql
In command -
drop table fact1 purge
Error report -
ORA-00942: table or view does not exist

Elapsed: 00:00:00.294
SQL> drop table fact1_source purge;

Table FACT1_SOURCE dropped.

Elapsed: 00:00:00.335
SQL>
SQL> --
SQL> -- In this case we are using VARCHAR2(20)
SQL> -- We have to keep the column under 64 bytes
SQL> -- to answer aggregate queries on this column
SQL> -- using stats.
SQL> --
SQL> create table fact1 (num0 number(10), num1 number(10), txt1 varchar2(20), txt2 varchar2(100));

Table FACT1 created.

Elapsed: 00:00:00.095
SQL>
SQL> create table fact1_source as
  2  select * from fact1 where 1=-1;

Table FACT1_SOURCE created.

Elapsed: 00:00:00.114
SQL>
SQL> insert /*+ APPEND */ into fact1_source
  2  select rownum,mod(rownum,10),'XXX'||rownum,'XXX'||rownum
  3  from   dual connect by rownum <= 10000;

10,000 rows inserted.

Elapsed: 00:00:00.541
SQL>
SQL> commit;

Commit complete.

Elapsed: 00:00:00.092
SQL>
SQL> --
SQL> -- Insert rows into FACT1
SQL> --
SQL> insert /*+ APPEND */ into fact1 select num0,0,txt1,txt2 from fact1_source;

10,000 rows inserted.

Elapsed: 00:00:00.497
SQL> commit;

Commit complete.

Elapsed: 00:00:00.094
SQL>
SQL> --
SQL> -- Let's speed up row generation...
SQL> --
SQL> set autocommit on
SQL> insert /*+ APPEND */ into fact1 select num0,1,txt1,txt2 from fact1;

10,000 rows inserted.

Commit complete.
Elapsed: 00:00:00.546
SQL> insert /*+ APPEND */ into fact1 select num0,2,txt1,txt2 from fact1;

20,000 rows inserted.

Commit complete.
Elapsed: 00:00:00.593
SQL> insert /*+ APPEND */ into fact1 select num0,3,txt1,txt2 from fact1;

40,000 rows inserted.

Commit complete.
Elapsed: 00:00:00.597
SQL> insert /*+ APPEND */ into fact1 select num0,4,txt1,txt2 from fact1;

80,000 rows inserted.

Commit complete.
Elapsed: 00:00:00.656
SQL> insert /*+ APPEND */ into fact1 select num0,5,txt1,txt2 from fact1;

160,000 rows inserted.

Commit complete.
Elapsed: 00:00:00.846
SQL> insert /*+ APPEND */ into fact1 select num0,6,txt1,txt2 from fact1;

320,000 rows inserted.

Commit complete.
Elapsed: 00:00:01.051
SQL> insert /*+ APPEND */ into fact1 select num0,7,txt1,txt2 from fact1;

640,000 rows inserted.

Commit complete.
Elapsed: 00:00:01.531
SQL> insert /*+ APPEND */ into fact1 select num0,8,txt1,txt2 from fact1;

1,280,000 rows inserted.

Commit complete.
Elapsed: 00:00:02.778
SQL> insert /*+ APPEND */ into fact1 select num0,9,txt1,txt2 from fact1;

2,560,000 rows inserted.

Commit complete.
Elapsed: 00:00:04.561
SQL> insert /*+ APPEND */ into fact1 select num0,10,txt1,txt2 from fact1;

5,120,000 rows inserted.

Commit complete.
Elapsed: 00:00:08.551
SQL> insert /*+ APPEND */ into fact1 select num0,11,txt1,txt2 from fact1;

10,240,000 rows inserted.

Commit complete.
Elapsed: 00:00:16.489
SQL> insert /*+ APPEND */ into fact1 select num0,12,txt1,txt2 from fact1;

20,480,000 rows inserted.

Commit complete.
Elapsed: 00:00:32.512
SQL> insert /*+ APPEND */ into fact1 select num0,13,txt1,txt2 from fact1;

40,960,000 rows inserted.

Commit complete.
Elapsed: 00:00:31.625
SQL> set autocommit off
Elapsed: 00:00:31.629
SQL> @test_stats
SQL> set echo on
SQL> set timing on
SQL> set linesize 250
SQL> set trims on
SQL> column "MAX(TXT1)" format a30
string beginning """ MAX(TXT1)" format a30 missing terminating quote (").
SQL> column "MIN(TXT1)" format a30
string beginning """ MIN(TXT1)" format a30 missing terminating quote (").
SQL> column "MAX(TXT2)" format a30
string beginning """ MAX(TXT2)" format a30 missing terminating quote (").
SQL> column "MIN(TXT2)" format a30
string beginning """ MIN(TXT2)" format a30 missing terminating quote (").
SQL>
SQL> --
SQL> -- The following queries use stats answering
SQL> --
SQL> select max(num0),min(num1) from fact1;

 MAX(NUM0)  MIN(NUM1)
---------- ----------
     10000          0

Elapsed: 00:00:00.461
SQL> @plan
SQL> set tab off
SQL> SET LINESIZE 250
SQL> SET PAGESIZE 500
SQL> SELECT * FROM table(DBMS_XPLAN.DISPLAY_CURSOR());

PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
SQL_ID  3x0hnv3a17a0u, child number 1
-------------------------------------
select max(num0),min(num1) from fact1

Plan hash value: 2785769099

------------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation                | Name                       | Rows  | Bytes | Cost (%CPU)| Time     |    TQ  |IN-OUT| PQ Distrib |
------------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT         |                            |       |       |   636 (100)|          |        |      |            |
|   1 |  RESULT CACHE            | 8snmj446pmydv19qwpzh6xvyz1 |       |       |            |          |        |      |            |
|   2 |   VIEW                   | VW_SQT_65BBF4BE            |     1 |    26 |   624  (76)| 00:00:01 |        |      |            |
|   3 |    SORT AGGREGATE        |                            |     1 |     7 |            |          |        |      |            |
|   4 |     PX COORDINATOR       |                            |       |       |            |          |        |      |            |
|   5 |      PX SEND QC (RANDOM) | :TQ10000                   |     1 |     7 |            |          |  Q1,00 | P->S | QC (RAND)  |
|   6 |       SORT AGGREGATE     |                            |     1 |     7 |            |          |  Q1,00 | PCWP |            |
|   7 |        PX BLOCK ITERATOR |                            |    81M|   546M|   624  (76)| 00:00:01 |  Q1,00 | PCWC |            |
|*  8 |         TABLE ACCESS FULL| FACT1                      |    81M|   546M|   624  (76)| 00:00:01 |  Q1,00 | PCWP |            |
------------------------------------------------------------------------------------------------------------------------------------

Predicate Information (identified by operation id):
---------------------------------------------------

   8 - access(:Z>=:Z AND :Z<=:Z)

Result Cache Information (identified by operation id):
------------------------------------------------------

   1 -

Note
-----
   - automatic DOP: Computed Degree of Parallelism is 2


34 rows selected.

Elapsed: 00:00:00.255
Elapsed: 00:00:00.256
SQL> pause p...
p...

SQL>
SQL> select max(num0),min(num1),min(txt1),max(txt1),count(*) from fact1;

 MAX(NUM0)  MIN(NUM1)
---------- ----------
MIN(TXT1)
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
MAX(TXT1)
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  COUNT(*)
----------
     10000          0
XXX1
XXX9999
  81920000


Elapsed: 00:00:00.326
SQL> @plan
SQL> set tab off
SQL> SET LINESIZE 250
SQL> SET PAGESIZE 500
SQL> SELECT * FROM table(DBMS_XPLAN.DISPLAY_CURSOR());

PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
SQL_ID  1zjjqqwsb9xtw, child number 1
-------------------------------------
select max(num0),min(num1),min(txt1),max(txt1),count(*) from fact1

Plan hash value: 2785769099

------------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation                | Name                       | Rows  | Bytes | Cost (%CPU)| Time     |    TQ  |IN-OUT| PQ Distrib |
------------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT         |                            |       |       |   702 (100)|          |        |      |            |
|   1 |  RESULT CACHE            | 83mmz0p9nqjjz3xmajxp4vgab2 |       |       |            |          |        |      |            |
|   2 |   VIEW                   | VW_SQT_65BBF4BE            |     1 |    63 |   679  (78)| 00:00:01 |        |      |            |
|   3 |    SORT AGGREGATE        |                            |     1 |    15 |            |          |        |      |            |
|   4 |     PX COORDINATOR       |                            |       |       |            |          |        |      |            |
|   5 |      PX SEND QC (RANDOM) | :TQ10000                   |     1 |    15 |            |          |  Q1,00 | P->S | QC (RAND)  |
|   6 |       SORT AGGREGATE     |                            |     1 |    15 |            |          |  Q1,00 | PCWP |            |
|   7 |        PX BLOCK ITERATOR |                            |    81M|  1171M|   679  (78)| 00:00:01 |  Q1,00 | PCWC |            |
|*  8 |         TABLE ACCESS FULL| FACT1                      |    81M|  1171M|   679  (78)| 00:00:01 |  Q1,00 | PCWP |            |
------------------------------------------------------------------------------------------------------------------------------------

Predicate Information (identified by operation id):
---------------------------------------------------

   8 - access(:Z>=:Z AND :Z<=:Z)

Result Cache Information (identified by operation id):
------------------------------------------------------

   1 -

Note
-----
   - automatic DOP: Computed Degree of Parallelism is 2


34 rows selected.

Elapsed: 00:00:00.161
Elapsed: 00:00:00.162
SQL> pause p...
p...

SQL>
SQL> select max(txt1),min(txt1),count(txt1) from fact1;

MAX(TXT1)
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
MIN(TXT1)
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
COUNT(TXT1)
-----------
XXX9999
XXX1
   81920000


Elapsed: 00:00:00.254
SQL> @plan
SQL> set tab off
SQL> SET LINESIZE 250
SQL> SET PAGESIZE 500
SQL> SELECT * FROM table(DBMS_XPLAN.DISPLAY_CURSOR());

PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
SQL_ID  76xvnad5mkgdf, child number 1
-------------------------------------
select max(txt1),min(txt1),count(txt1) from fact1

Plan hash value: 2785769099

------------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation                | Name                       | Rows  | Bytes | Cost (%CPU)| Time     |    TQ  |IN-OUT| PQ Distrib |
------------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT         |                            |       |       |   696 (100)|          |        |      |            |
|   1 |  RESULT CACHE            | 0y7h584kyccbbcb7tq72r16v18 |       |       |            |          |        |      |            |
|   2 |   VIEW                   | VW_SQT_65BBF4BE            |     1 |    37 |   679  (78)| 00:00:01 |        |      |            |
|   3 |    SORT AGGREGATE        |                            |     1 |     8 |            |          |        |      |            |
|   4 |     PX COORDINATOR       |                            |       |       |            |          |        |      |            |
|   5 |      PX SEND QC (RANDOM) | :TQ10000                   |     1 |     8 |            |          |  Q1,00 | P->S | QC (RAND)  |
|   6 |       SORT AGGREGATE     |                            |     1 |     8 |            |          |  Q1,00 | PCWP |            |
|   7 |        PX BLOCK ITERATOR |                            |    81M|   625M|   679  (78)| 00:00:01 |  Q1,00 | PCWC |            |
|*  8 |         TABLE ACCESS FULL| FACT1                      |    81M|   625M|   679  (78)| 00:00:01 |  Q1,00 | PCWP |            |
------------------------------------------------------------------------------------------------------------------------------------

Predicate Information (identified by operation id):
---------------------------------------------------

   8 - access(:Z>=:Z AND :Z<=:Z)

Result Cache Information (identified by operation id):
------------------------------------------------------

   1 -

Note
-----
   - automatic DOP: Computed Degree of Parallelism is 2


34 rows selected.

Elapsed: 00:00:00.182
Elapsed: 00:00:00.182
SQL> pause p...
p...

SQL>
SQL> select approx_count_distinct(num1) from fact1;

APPROX_COUNT_DISTINCT(NUM1)
---------------------------
                         14

Elapsed: 00:00:00.160
SQL> @plan
SQL> set tab off
SQL> SET LINESIZE 250
SQL> SET PAGESIZE 500
SQL> SELECT * FROM table(DBMS_XPLAN.DISPLAY_CURSOR());

PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
SQL_ID  g05pjsw2y6hvs, child number 1
-------------------------------------
select approx_count_distinct(num1) from fact1

Plan hash value: 2785769099

--------------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation                  | Name                       | Rows  | Bytes | Cost (%CPU)| Time     |    TQ  |IN-OUT| PQ Distrib |
--------------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT           |                            |       |       |   631 (100)|          |        |      |            |
|   1 |  RESULT CACHE              | 7k4xby1uch9px0db3nb93wfpz7 |       |       |            |          |        |      |            |
|   2 |   VIEW                     | VW_SQT_65BBF4BE            |     1 |    13 |   624  (76)| 00:00:01 |        |      |            |
|   3 |    SORT AGGREGATE APPROX   |                            |     1 |     3 |            |          |        |      |            |
|   4 |     PX COORDINATOR         |                            |       |       |            |          |        |      |            |
|   5 |      PX SEND QC (RANDOM)   | :TQ10000                   |     1 |     3 |            |          |  Q1,00 | P->S | QC (RAND)  |
|   6 |       SORT AGGREGATE APPROX|                            |     1 |     3 |            |          |  Q1,00 | PCWP |            |
|   7 |        PX BLOCK ITERATOR   |                            |    81M|   234M|   624  (76)| 00:00:01 |  Q1,00 | PCWC |            |
|*  8 |         TABLE ACCESS FULL  | FACT1                      |    81M|   234M|   624  (76)| 00:00:01 |  Q1,00 | PCWP |            |
--------------------------------------------------------------------------------------------------------------------------------------

Predicate Information (identified by operation id):
---------------------------------------------------

   8 - access(:Z>=:Z AND :Z<=:Z)

Result Cache Information (identified by operation id):
------------------------------------------------------

   1 -

Note
-----
   - automatic DOP: Computed Degree of Parallelism is 2


34 rows selected.

Elapsed: 00:00:00.160
Elapsed: 00:00:00.160
SQL> pause p...
p...

SQL>
SQL> --
SQL> -- The following queries do not use stats query answering.
SQL> --
SQL>
SQL> --
SQL> -- WHERE clause
SQL> --
SQL> select max(num1) from fact1 where num1 > 0;

 MAX(NUM1)
----------
        13

Elapsed: 00:00:01.360
SQL> @plan
SQL> set tab off
SQL> SET LINESIZE 250
SQL> SET PAGESIZE 500
SQL> SELECT * FROM table(DBMS_XPLAN.DISPLAY_CURSOR());

PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
SQL_ID  0rqq0xxkgzfyf, child number 1
-------------------------------------
select max(num1) from fact1 where num1 > 0

Plan hash value: 2304087426

-----------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation               | Name                       | Rows  | Bytes | Cost (%CPU)| Time     |    TQ  |IN-OUT| PQ Distrib |
-----------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT        |                            |       |       |   763 (100)|          |        |      |            |
|   1 |  RESULT CACHE           | dvgb77c1dc3s52ny5zpufq7qph |       |       |            |          |        |      |            |
|   2 |   SORT AGGREGATE        |                            |     1 |     3 |            |          |        |      |            |
|   3 |    PX COORDINATOR       |                            |       |       |            |          |        |      |            |
|   4 |     PX SEND QC (RANDOM) | :TQ10000                   |     1 |     3 |            |          |  Q1,00 | P->S | QC (RAND)  |
|   5 |      SORT AGGREGATE     |                            |     1 |     3 |            |          |  Q1,00 | PCWP |            |
|   6 |       PX BLOCK ITERATOR |                            |    81M|   234M|   763  (80)| 00:00:01 |  Q1,00 | PCWC |            |
|*  7 |        TABLE ACCESS FULL| FACT1                      |    81M|   234M|   763  (80)| 00:00:01 |  Q1,00 | PCWP |            |
-----------------------------------------------------------------------------------------------------------------------------------

Predicate Information (identified by operation id):
---------------------------------------------------

   7 - access(:Z>=:Z AND :Z<=:Z)
       filter("NUM1">0)

Result Cache Information (identified by operation id):
------------------------------------------------------

   1 -

Note
-----
   - automatic DOP: Computed Degree of Parallelism is 4


34 rows selected.

Elapsed: 00:00:00.141
Elapsed: 00:00:00.142
SQL> pause p...
p...

SQL>
SQL> --
SQL> -- TXT2 column is VARCHAR2(100) - too wide
SQL> --
SQL> select min(txt2), max(txt2) from fact1;

MIN(TXT2)                                                                                            MAX(TXT2)
---------------------------------------------------------------------------------------------------- ----------------------------------------------------------------------------------------------------
XXX1                                                                                                 XXX9999

Elapsed: 00:00:01.553
SQL> @plan
SQL> set tab off
SQL> SET LINESIZE 250
SQL> SET PAGESIZE 500
SQL> SELECT * FROM table(DBMS_XPLAN.DISPLAY_CURSOR());

PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
SQL_ID  a19svh2shq0x2, child number 1
-------------------------------------
select min(txt2), max(txt2) from fact1

Plan hash value: 2304087426

-----------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation               | Name                       | Rows  | Bytes | Cost (%CPU)| Time     |    TQ  |IN-OUT| PQ Distrib |
-----------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT        |                            |       |       |   735 (100)|          |        |      |            |
|   1 |  RESULT CACHE           | ad0zxx3tb7rbv9x0kyc0gx1y4z |       |       |            |          |        |      |            |
|   2 |   SORT AGGREGATE        |                            |     1 |     8 |            |          |        |      |            |
|   3 |    PX COORDINATOR       |                            |       |       |            |          |        |      |            |
|   4 |     PX SEND QC (RANDOM) | :TQ10000                   |     1 |     8 |            |          |  Q1,00 | P->S | QC (RAND)  |
|   5 |      SORT AGGREGATE     |                            |     1 |     8 |            |          |  Q1,00 | PCWP |            |
|   6 |       PX BLOCK ITERATOR |                            |    81M|   625M|   735  (80)| 00:00:01 |  Q1,00 | PCWC |            |
|*  7 |        TABLE ACCESS FULL| FACT1                      |    81M|   625M|   735  (80)| 00:00:01 |  Q1,00 | PCWP |            |
-----------------------------------------------------------------------------------------------------------------------------------

Predicate Information (identified by operation id):
---------------------------------------------------

   7 - access(:Z>=:Z AND :Z<=:Z)

Result Cache Information (identified by operation id):
------------------------------------------------------

   1 -

Note
-----
   - automatic DOP: Computed Degree of Parallelism is 4


33 rows selected.

Elapsed: 00:00:00.166
Elapsed: 00:00:00.167
SQL> pause p...
p...

SQL>
SQL> --
SQL> -- Not a supported aggregate
SQL> --
SQL> select sum(num1) from fact1;

 SUM(NUM1)
----------
 983050000

Elapsed: 00:00:01.237
SQL> @plan
SQL> set tab off
SQL> SET LINESIZE 250
SQL> SET PAGESIZE 500
SQL> SELECT * FROM table(DBMS_XPLAN.DISPLAY_CURSOR());

PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
SQL_ID  2xdrfdubucvqd, child number 1
-------------------------------------
select sum(num1) from fact1

Plan hash value: 2304087426

-----------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation               | Name                       | Rows  | Bytes | Cost (%CPU)| Time     |    TQ  |IN-OUT| PQ Distrib |
-----------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT        |                            |       |       |   624 (100)|          |        |      |            |
|   1 |  RESULT CACHE           | 9kbxx6zcamdj8gdn07udj33md6 |       |       |            |          |        |      |            |
|   2 |   SORT AGGREGATE        |                            |     1 |     3 |            |          |        |      |            |
|   3 |    PX COORDINATOR       |                            |       |       |            |          |        |      |            |
|   4 |     PX SEND QC (RANDOM) | :TQ10000                   |     1 |     3 |            |          |  Q1,00 | P->S | QC (RAND)  |
|   5 |      SORT AGGREGATE     |                            |     1 |     3 |            |          |  Q1,00 | PCWP |            |
|   6 |       PX BLOCK ITERATOR |                            |    81M|   234M|   624  (76)| 00:00:01 |  Q1,00 | PCWC |            |
|*  7 |        TABLE ACCESS FULL| FACT1                      |    81M|   234M|   624  (76)| 00:00:01 |  Q1,00 | PCWP |            |
-----------------------------------------------------------------------------------------------------------------------------------

Predicate Information (identified by operation id):
---------------------------------------------------

   7 - access(:Z>=:Z AND :Z<=:Z)

Result Cache Information (identified by operation id):
------------------------------------------------------

   1 -

Note
-----
   - automatic DOP: Computed Degree of Parallelism is 4


33 rows selected.

Elapsed: 00:00:00.341
Elapsed: 00:00:00.341
SQL> pause p...
p...

SQL>
SQL> --
SQL> -- Incidentally, the result cache helps us
SQL> -- out instead. If the query is executed a
SQL> -- second time, we can get the result from cache.
SQL> --
SQL> select sum(num1) from fact1;

 SUM(NUM1)
----------
 983050000

Elapsed: 00:00:00.589
SQL> @plan
SQL> set tab off
SQL> SET LINESIZE 250
SQL> SET PAGESIZE 500
SQL> SELECT * FROM table(DBMS_XPLAN.DISPLAY_CURSOR());

PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
SQL_ID  2xdrfdubucvqd, child number 1
-------------------------------------
select sum(num1) from fact1

Plan hash value: 2304087426

-----------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation               | Name                       | Rows  | Bytes | Cost (%CPU)| Time     |    TQ  |IN-OUT| PQ Distrib |
-----------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT        |                            |       |       |   624 (100)|          |        |      |            |
|   1 |  RESULT CACHE           | 9kbxx6zcamdj8gdn07udj33md6 |       |       |            |          |        |      |            |
|   2 |   SORT AGGREGATE        |                            |     1 |     3 |            |          |        |      |            |
|   3 |    PX COORDINATOR       |                            |       |       |            |          |        |      |            |
|   4 |     PX SEND QC (RANDOM) | :TQ10000                   |     1 |     3 |            |          |  Q1,00 | P->S | QC (RAND)  |
|   5 |      SORT AGGREGATE     |                            |     1 |     3 |            |          |  Q1,00 | PCWP |            |
|   6 |       PX BLOCK ITERATOR |                            |    81M|   234M|   624  (76)| 00:00:01 |  Q1,00 | PCWC |            |
|*  7 |        TABLE ACCESS FULL| FACT1                      |    81M|   234M|   624  (76)| 00:00:01 |  Q1,00 | PCWP |            |
-----------------------------------------------------------------------------------------------------------------------------------

Predicate Information (identified by operation id):
---------------------------------------------------

   7 - access(:Z>=:Z AND :Z<=:Z)

Result Cache Information (identified by operation id):
------------------------------------------------------

   1 -

Note
-----
   - automatic DOP: Computed Degree of Parallelism is 4


33 rows selected.

Elapsed: 00:00:00.421
Elapsed: 00:00:00.421
SQL> pause p...
p...

SQL>
SQL> --
SQL> -- Not a simple column aggregate
SQL> --
SQL> select max(num1+10) from fact1;

MAX(NUM1+10)
------------
          23

Elapsed: 00:00:01.541
SQL> @plan
SQL> set tab off
SQL> SET LINESIZE 250
SQL> SET PAGESIZE 500
SQL> SELECT * FROM table(DBMS_XPLAN.DISPLAY_CURSOR());

PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
SQL_ID  790j5tmk17my6, child number 1
-------------------------------------
select max(num1+10) from fact1

Plan hash value: 2304087426

-----------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation               | Name                       | Rows  | Bytes | Cost (%CPU)| Time     |    TQ  |IN-OUT| PQ Distrib |
-----------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT        |                            |       |       |   624 (100)|          |        |      |            |
|   1 |  RESULT CACHE           | 057wy377d2nstfcptx3wy7h1r3 |       |       |            |          |        |      |            |
|   2 |   SORT AGGREGATE        |                            |     1 |     3 |            |          |        |      |            |
|   3 |    PX COORDINATOR       |                            |       |       |            |          |        |      |            |
|   4 |     PX SEND QC (RANDOM) | :TQ10000                   |     1 |     3 |            |          |  Q1,00 | P->S | QC (RAND)  |
|   5 |      SORT AGGREGATE     |                            |     1 |     3 |            |          |  Q1,00 | PCWP |            |
|   6 |       PX BLOCK ITERATOR |                            |    81M|   234M|   624  (76)| 00:00:01 |  Q1,00 | PCWC |            |
|*  7 |        TABLE ACCESS FULL| FACT1                      |    81M|   234M|   624  (76)| 00:00:01 |  Q1,00 | PCWP |            |
-----------------------------------------------------------------------------------------------------------------------------------

Predicate Information (identified by operation id):
---------------------------------------------------

   7 - access(:Z>=:Z AND :Z<=:Z)

Result Cache Information (identified by operation id):
------------------------------------------------------

   1 -

Note
-----
   - automatic DOP: Computed Degree of Parallelism is 4


33 rows selected.

Elapsed: 00:00:00.150
Elapsed: 00:00:00.150
SQL> pause p...
p...

SQL>
SQL> --
SQL> -- Let's get a baseline elapsed time for this query
SQL> --
SQL> select /* RUN1 */ max(num0),min(num0),min(num1),max(num1) from fact1;

 MAX(NUM0)  MIN(NUM0)  MIN(NUM1)  MAX(NUM1)
---------- ---------- ---------- ----------
     10000          1          0         13

Elapsed: 00:00:00.275
SQL> -- Note the short elapsed time because we are using stats
SQL> pause p...
p...

SQL>
SQL> --
SQL> -- DML prevents us from using stats to answer our query
SQL> -- so we'll insert a row and re-try the "RUN1" query again.
SQL> -- I'm using a different comment (RUN2) to change the query text so we
SQL> -- get a new query in the cursor cache. It's the same query though
SQL> -- of course.
SQL> --
SQL> insert into fact1 values (1,1,'XXX1','XXX1');

1 row inserted.

Elapsed: 00:00:00.087
SQL> commit;

Commit complete.

Elapsed: 00:00:00.085
SQL> select /* RUN2 */ max(num0),min(num0),min(num1),max(num1) from fact1;

 MAX(NUM0)  MIN(NUM0)  MIN(NUM1)  MAX(NUM1)
---------- ---------- ---------- ----------
     10000          1          0         13

Elapsed: 00:00:02.401
SQL> -- The DML has prevented us from using stats and this is
SQL> -- reflected in the longer elapsed time.
SQL> pause p...
p...

SQL>
SQL> select /* RUN3 */ max(num0),min(num0),min(num1),max(num1) from fact1;

 MAX(NUM0)  MIN(NUM0)  MIN(NUM1)  MAX(NUM1)
---------- ---------- ---------- ----------
     10000          1          0         13

Elapsed: 00:00:02.393
SQL> @plan
SQL> set tab off
SQL> SET LINESIZE 250
SQL> SET PAGESIZE 500
SQL> SELECT * FROM table(DBMS_XPLAN.DISPLAY_CURSOR());

PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
SQL_ID  dm9mw5035bvtg, child number 1
-------------------------------------
select /* RUN3 */ max(num0),min(num0),min(num1),max(num1) from fact1

Plan hash value: 2785769099

------------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation                | Name                       | Rows  | Bytes | Cost (%CPU)| Time     |    TQ  |IN-OUT| PQ Distrib |
------------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT         |                            |       |       |   644 (100)|          |        |      |            |
|   1 |  RESULT CACHE            | 78j6rrqh3x49y4kza3c7kbs872 |       |       |            |          |        |      |            |
|   2 |   VIEW                   | VW_SQT_65BBF4BE            |     1 |    52 |   624  (76)| 00:00:01 |        |      |            |
|   3 |    SORT AGGREGATE        |                            |     1 |     7 |            |          |        |      |            |
|   4 |     PX COORDINATOR       |                            |       |       |            |          |        |      |            |
|   5 |      PX SEND QC (RANDOM) | :TQ10000                   |     1 |     7 |            |          |  Q1,00 | P->S | QC (RAND)  |
|   6 |       SORT AGGREGATE     |                            |     1 |     7 |            |          |  Q1,00 | PCWP |            |
|   7 |        PX BLOCK ITERATOR |                            |    81M|   546M|   624  (76)| 00:00:01 |  Q1,00 | PCWC |            |
|*  8 |         TABLE ACCESS FULL| FACT1                      |    81M|   546M|   624  (76)| 00:00:01 |  Q1,00 | PCWP |            |
------------------------------------------------------------------------------------------------------------------------------------

Predicate Information (identified by operation id):
---------------------------------------------------

   8 - access(:Z>=:Z AND :Z<=:Z)

Result Cache Information (identified by operation id):
------------------------------------------------------

   1 -

Note
-----
   - automatic DOP: Computed Degree of Parallelism is 2


34 rows selected.

Elapsed: 00:00:00.178
Elapsed: 00:00:00.178
SQL> -- The plan reflects that stats query answering is POSSIBLE.
SQL> -- In this case it could not be used because of the DML and this
SQL> -- is reflected in the longer elapsed time (than the
SQL> -- RUN1 example above).
SQL> pause p...
p...

SQL>
SQL> --
SQL> -- Get stats back up to date
SQL> --
SQL> exec dbms_stats.gather_table_stats(user,'FACT1');

PL/SQL procedure successfully completed.

Elapsed: 00:00:26.637
Elapsed: 00:00:26.638
SQL>
SQL> spool off
